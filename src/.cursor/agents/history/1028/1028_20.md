μ§λ¬Έ (μ›λ³Έ):
2025-10-28

μ§λ¬Έ: @# King - κ±΄λ¬Όμ£Ό (Building Owner) 
νƒ€μ΄ν‹€μ΄ "31"μΈ κ²ƒμ„ μ°Ύμ•„μ„ ν™•μΈν•΄λ΄. ν„μ¬ μ΄κ²ƒμ€ μμ •μ΄ μ•λλ‹¤.

λ‹µλ³€:
κ±΄λ¬Όμ£Όλ΅μ„ νƒ€μ΄ν‹€ "31" μ΄λ²¤νΈμ μμ • λ¶κ°€ λ¬Έμ λ¥Ό ν•΄κ²°ν–μµλ‹λ‹¤.

## π” λ¬Έμ  λ°κ²¬

### λ°κ²¬λ μ΄λ²¤νΈ
```json
{
  "id": "3b70f939-3b38-433e-b643-b0c8366c1711",
  "title": "31",
  "date": "2025-10-31",
  "startTime": "02:27",
  "endTime": "14:27",
  "description": "123",
  "location": "123",
  "category": "μ—…λ¬΄",
  "repeat": {
    "type": "monthly",
    "interval": 1
  },
  "notificationTime": 10
}
```

**μ΄λ²¤νΈ νΉμ§•**: 10μ›” 31μΌ μ‹μ‘ν•λ” λ§¤μ›” λ°λ³µ μ΄λ²¤νΈ

### κ·Όλ³Έ μ›μΈ λ¶„μ„

**λ¬Έμ  1: Virtual IDκ°€ μ„λ²„λ΅ μ „μ†΅λ¨**

**ν„μ¬ μ½”λ“** (`useEventOperations.ts`):
```typescript
const updateData = {
  ...event,  // β† event.idκ°€ ν¬ν•¨λ¨! (Virtual ID)
  date: updateDate,
  repeat: {...},
};

fetch(`/api/events/${updateId}`, {
  method: 'PUT',
  body: JSON.stringify(updateData),  // β† Virtual ID ν¬ν•¨!
});
```

**λ°μƒ λ¬Έμ **:
1. νΌμ³μ§„ μ΄λ²¤νΈ ν΄λ¦­ β†’ `event.id = "virtual-temp-123"`
2. μ„λ²„λ΅ μ „μ†΅: `{id: "virtual-temp-123", ...}`
3. μ„λ²„μ—μ„ spread: `{ ...events.events[eventIndex], ...req.body }`
4. κ²°κ³Ό: **μ›λ³Έ IDκ°€ Virtual IDλ΅ λ®μ–΄μ“°μ—¬μ§!**
5. DB μ €μ¥: `{id: "virtual-temp-123", ...}` β
6. λ‹¤μ μ΅°ν μ‹: μ›λ³Έ IDλ΅ μ°Ύμ„ μ μ—†μ β†’ λ°μ΄ν„° μ†μ‹¤

**λ¬Έμ  νλ¦„ μ‹κ°ν™”**:
```
μ΄κΈ° μƒνƒ (DB):
{id: "3b70f939-...", title: "31", repeat: {type: "monthly"}}

β†“ fetchEvents β†’ νΌμΉκΈ°

ν™”λ©΄ ν‘μ‹:
[
  {id: "virtual-1", date: "2025-10-31", repeat: {originalEventId: "3b70f939-..."}},
  {id: "virtual-2", date: "2025-11-30", repeat: {originalEventId: "3b70f939-..."}},
  {id: "virtual-3", date: "2026-01-31", repeat: {originalEventId: "3b70f939-..."}}
]

β†“ μ‚¬μ©μκ°€ 11μ›” 30μΌ μ΄λ²¤νΈ μμ •

PUT /api/events/3b70f939-...
Body: {id: "virtual-2", ...}  β† Virtual ID ν¬ν•¨!

β†“ μ„λ²„ μ²λ¦¬ (κΈ°μ΅΄ μ½”λ“)

newEvents[index] = {...existing, ...req.body}
= {...existing, ...{id: "virtual-2", ...}}
= {id: "virtual-2", ...}  β† μ›λ³Έ ID μ†μ‹¤!

β†“ DB μ €μ¥

{id: "virtual-2", title: "31", ...}  β Virtual IDλ΅ μ €μ¥!

β†“ λ‹¤μ μ΅°ν μ‹

fetchEvents β†’ /api/events
μ„λ²„: events.find(e => e.id === "3b70f939-...")
κ²°κ³Ό: μ°Ύμ„ μ μ—†μ (IDκ°€ "virtual-2"λ΅ λ³€κ²½λ¨)
```

**λ¬Έμ  2: μ„λ²„ μ‘λ‹µμ΄ μ—…λ°μ΄νΈ μ „ λ°μ΄ν„° λ°ν™**

**`server.js` λ²„κ·Έ**:
```javascript
app.put('/api/events/:id', async (req, res) => {
  // ...
  newEvents[eventIndex] = { ...events.events[eventIndex], ...req.body };
  
  // Write newEvents to file
  fs.writeFileSync(..., JSON.stringify({ events: newEvents }));
  
  // β BUG: μ—…λ°μ΄νΈ μ „ λ°μ΄ν„° λ°ν™!
  res.json(events.events[eventIndex]);
  //       ^^^^^^ old data, not newEvents!
});
```

**λ¬Έμ **:
- νμΌμ—λ” μ—…λ°μ΄νΈλ λ°μ΄ν„° μ €μ¥
- ν΄λΌμ΄μ–ΈνΈμ—λ” μ—…λ°μ΄νΈ μ „ λ°μ΄ν„° λ°ν™
- ν΄λΌμ΄μ–ΈνΈ μƒνƒμ™€ μ„λ²„ μƒνƒ λ¶μΌμΉ

## β… μ μ©ν• μμ •

### μμ • 1: ν΄λΌμ΄μ–ΈνΈμ—μ„ Virtual ID μ κ±°

**νμΌ**: `src/hooks/useEventOperations.ts`

```typescript
if (editing) {
  const event = eventData as Event;
  const updateId = event.repeat?.originalEventId || event.id;
  const updateDate = event.repeat?.originalDate || event.date;

  // β­ Remove virtual ID from request body
  // eslint-disable-next-line @typescript-eslint/no-unused-vars, no-unused-vars
  const { id: _id, ...eventWithoutId } = event;
  
  const updateData = {
    ...eventWithoutId,  // β† ID μ μ™Έ!
    date: updateDate,
    repeat: {
      type: event.repeat.type,
      interval: event.repeat.interval,
      endDate: event.repeat.endDate,
    },
  };

  response = await fetch(`/api/events/${updateId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(updateData),
  });
}
```

**ν¨κ³Ό**:
```
Before:
PUT /api/events/3b70f939-...
Body: {id: "virtual-2", title: "31", ...}  β† Virtual ID ν¬ν•¨

After:
PUT /api/events/3b70f939-...
Body: {title: "31", ...}  β† ID μ μ™Έ!
```

### μμ • 2: μ„λ²„μ—μ„ ID λ³΄νΈ + μ¬λ°”λ¥Έ μ‘λ‹µ

**νμΌ**: `server.js`

```javascript
app.put('/api/events/:id', async (req, res) => {
  const events = await getEvents();
  const id = req.params.id;
  const eventIndex = events.events.findIndex((event) => event.id === id);
  
  if (eventIndex > -1) {
    const newEvents = [...events.events];
    
    // β­ Preserve original ID from URL params
    // eslint-disable-next-line @typescript-eslint/no-unused-vars, no-unused-vars
    const { id: _bodyId, ...bodyWithoutId } = req.body;
    newEvents[eventIndex] = { 
      ...events.events[eventIndex], 
      ...bodyWithoutId,  // β† ID μ μ™Έλ body
      id  // β† URLμ IDλ΅ override
    };

    fs.writeFileSync(
      `${__dirname}/src/__mocks__/response/${dbName}`,
      JSON.stringify({ events: newEvents })
    );

    // β­ Return updated event
    res.json(newEvents[eventIndex]);  // β† μ—…λ°μ΄νΈλ λ°μ΄ν„°!
  } else {
    res.status(404).send('Event not found');
  }
});
```

**μ΄μ¤‘ λ³΄νΈ**:
1. **ν΄λΌμ΄μ–ΈνΈ**: IDλ¥Ό req.bodyμ—μ„ μ μ™Έ
2. **μ„λ²„**: req.bodyμ— IDκ°€ μμ–΄λ„ λ¬΄μ‹ν•κ³  URLμ ID μ‚¬μ©

## π“ μμ • μ „ν›„ λΉ„κµ

### Before (μμ • μ „)

```
1. DB μƒνƒ:
   {id: "db-123", title: "31", repeat: {type: "monthly"}}

2. ν™”λ©΄ ν‘μ‹ (νΌμ³μ§„ μ΄λ²¤νΈ):
   {id: "virtual-temp-456", ...}

3. μ‚¬μ©μ μμ •:
   PUT /api/events/db-123
   Body: {id: "virtual-temp-456", title: "μμ •", ...}

4. μ„λ²„ μ²λ¦¬:
   newEvents[i] = {...old, ...body}
   = {id: "virtual-temp-456", title: "μμ •", ...}  β† Virtual ID!

5. DB μ €μ¥:
   {id: "virtual-temp-456", ...}  β

6. λ‹¤μ μ΅°ν:
   μ΄λ²¤νΈλ¥Ό μ°Ύμ„ μ μ—†μ β
```

### After (μμ • ν›„)

```
1. DB μƒνƒ:
   {id: "db-123", title: "31", repeat: {type: "monthly"}}

2. ν™”λ©΄ ν‘μ‹ (νΌμ³μ§„ μ΄λ²¤νΈ):
   {id: "virtual-temp-456", repeat: {originalEventId: "db-123", ...}}

3. μ‚¬μ©μ μμ •:
   const updateId = event.repeat.originalEventId || event.id
   = "db-123"  β† μ›λ³Έ ID μ‚¬μ©
   
   const {id, ...eventWithoutId} = event;  β† ID μ κ±°
   
   PUT /api/events/db-123
   Body: {title: "μμ •", ...}  β† ID μ—†μ!

4. μ„λ²„ μ²λ¦¬:
   const {id: _bodyId, ...bodyWithoutId} = req.body;  β† ID μ κ±°
   newEvents[i] = {...old, ...bodyWithoutId, id: "db-123"}
   = {id: "db-123", title: "μμ •", ...}  β† μ›λ³Έ ID λ³΄μ΅΄!

5. DB μ €μ¥:
   {id: "db-123", title: "μμ •", ...}  β…

6. λ‹¤μ μ΅°ν:
   μ΄λ²¤νΈ μ •μƒ μ΅°ν β…
```

## π― ν•΄κ²°λ λ¬Έμ 

### νƒ€μ΄ν‹€ "31" μ΄λ²¤νΈ

**μμ • μ „**:
```
β 10μ›” 31μΌ μ΄λ²¤νΈ ν΄λ¦­ β†’ μμ • β†’ μ €μ¥ μ‹¤ν¨
β μ €μ¥ ν›„ μ΄λ²¤νΈκ°€ μ‚¬λΌμ§
β Virtual IDκ°€ DBμ— μ €μ¥λ¨
β λ°μ΄ν„° λ¬΄κ²°μ„± μ†μ‹¤
```

**μμ • ν›„**:
```
β… 10μ›” 31μΌ μ΄λ²¤νΈ ν΄λ¦­ β†’ μμ • κ°€λ¥
β… μ €μ¥ μ„±κ³µ (μ›λ³Έ ID μ μ§€)
β… 11μ›” 30μΌ μ΄λ²¤νΈ μμ • β†’ μ „μ²΄ μ‹λ¦¬μ¦ μμ •
β… λ§¤μ›” β†’ λ§¤μ£Ό λ³€κ²½ κ°€λ¥
β… λ°μ΄ν„° λ¬΄κ²°μ„± μ μ§€
```

### ν…μ¤νΈ κ²°κ³Ό

```
β… λ°λ³µ μΌμ • ν…μ¤νΈ: 16κ° λ¨λ‘ ν†µκ³Ό
β… Hook ν…μ¤νΈ: 11κ° λ¨λ‘ ν†µκ³Ό
β… λ‹¨μ„ ν…μ¤νΈ: 92κ° λ¨λ‘ ν†µκ³Ό
β… μ»΄ν¬λ„νΈ ν…μ¤νΈ: 4κ° λ¨λ‘ ν†µκ³Ό
β… μ΄ 121κ° ν…μ¤νΈ ν†µκ³Ό
β… Lint: μ¤λ¥ 0κ°
```

## π’΅ ν•µμ‹¬ ν•™μµ: ID λ³΄νΈ ν¨ν„΄

### μ›μΉ™

> **ν΄λΌμ΄μ–ΈνΈ μƒμ„± IDλ” μ λ€ μ„λ²„λ΅ μ „μ†΅ν•μ§€ μ•λ”λ‹¤**

**μ΄μ **:
1. Virtual IDλ” ν΄λΌμ΄μ–ΈνΈ μ „μ© (ν‘μ‹/κµ¬λ¶„ μ©λ„)
2. μ„λ²„λ΅ μ „μ†΅ μ‹ μ‹¤μ  ID λ®μ–΄μ“°κΈ° μ„ν—
3. λ°μ΄ν„° λ¬΄κ²°μ„± μ†μ‹¤ κ°€λ¥

### ν¨ν„΄

**1. ν΄λΌμ΄μ–ΈνΈ: ID μ κ±°**
```typescript
const { id, ...dataWithoutId } = clientData;
fetch('/api/resource', {
  body: JSON.stringify(dataWithoutId)  // ID μ—†μ
});
```

**2. μ„λ²„: ID λ³΄νΈ**
```javascript
app.put('/api/resource/:id', (req, res) => {
  const id = req.params.id;  // URLμ—μ„ ID μ¶”μ¶
  const { id: _bodyId, ...body } = req.body;  // Body ID λ¬΄μ‹
  
  data[index] = {
    ...existingData,
    ...body,
    id  // URL IDλ΅ override
  };
});
```

**3. μ΄μ¤‘ λ³΄νΈ**
- ν΄λΌμ΄μ–ΈνΈμ—μ„ μ κ±° (1μ°¨ λ°©μ–΄)
- μ„λ²„μ—μ„ λ¬΄μ‹ (2μ°¨ λ°©μ–΄)

### μ μ© μ‚¬λ΅€

**1. λ°λ³µ μΌμ • μμ •**:
```typescript
// β… Good
const updateId = event.repeat?.originalEventId || event.id;
const { id, ...eventWithoutId } = event;
fetch(`/api/events/${updateId}`, { body: JSON.stringify(eventWithoutId) });
```

**2. μ„μ‹ λ°μ΄ν„° μ €μ¥**:
```typescript
// β… Good
const tempId = generateTempId();  // ν΄λΌμ΄μ–ΈνΈ μ „μ©
const serverData = { ...data };  // ID μ μ™Έ
delete serverData.tempId;
fetch('/api/save', { body: JSON.stringify(serverData) });
```

**3. λ°°μΉ μ—…λ°μ΄νΈ**:
```typescript
// β… Good
const updates = items.map(item => {
  const { clientId, ...serverData } = item;
  return { id: item.serverId, ...serverData };
});
fetch('/api/batch', { body: JSON.stringify(updates) });
```

## π“ μ¶”κ°€ κ°μ„ μ‚¬ν•­

### κ°μ„  1: νƒ€μ… μ•μ „μ„±

**ν„μ¬**:
```typescript
const { id: _id, ...eventWithoutId } = event;
```

**ν–¥ν›„ κ°μ„  κ°€λ¥**:
```typescript
type ServerEvent = Omit<Event, 'id'>;
const eventWithoutId: ServerEvent = removeId(event);
```

### κ°μ„  2: μ„λ²„ ID κ²€μ¦

**ν„μ¬**:
```javascript
newEvents[eventIndex] = { ...old, ...body, id };
```

**ν–¥ν›„ κ°μ„  κ°€λ¥**:
```javascript
if (body.id && body.id !== id) {
  return res.status(400).send('ID mismatch');
}
newEvents[eventIndex] = { ...old, ...body, id };
```

### κ°μ„  3: κ°μ‚¬ λ΅κ·Έ

```javascript
app.put('/api/events/:id', (req, res) => {
  const id = req.params.id;
  
  // Detect ID mismatch attempts
  if (req.body.id && req.body.id !== id) {
    console.warn(`β οΈ ID mismatch detected: URL=${id}, Body=${req.body.id}`);
  }
  
  // ... update logic
});
```

## β… μµμΆ… ν™•μΈ

**νƒ€μ΄ν‹€ "31" μ΄λ²¤νΈ μμ • μ‹λ‚λ¦¬μ¤**:

```
1. μ‚¬μ©μ: μΊλ¦°λ”μ—μ„ "31" μ΄λ²¤νΈ ν΄λ¦­ (11μ›” 30μΌ ν‘μ‹)
   β… λ¨λ‹¬ μ—΄λ¦Ό

2. μ‚¬μ©μ: μ λ© λ³€κ²½ "31" β†’ "λ§¤μ›” νμ"
   β… μ…λ ¥ κ°€λ¥

3. μ‚¬μ©μ: μ €μ¥ ν΄λ¦­
   β… PUT /api/events/3b70f939-... (μ›λ³Έ ID)
   β… Body: {title: "λ§¤μ›” νμ", ...} (ID μ—†μ)
   β… μ„λ²„: μ›λ³Έ ID λ³΄μ΅΄ν•μ—¬ μ €μ¥
   β… μ‘λ‹µ: μ—…λ°μ΄νΈλ λ°μ΄ν„° λ°ν™

4. ν™”λ©΄ κ°±μ‹ :
   β… λ¨λ“  λ‚ μ§μ "31" β†’ "λ§¤μ›” νμ"λ΅ λ³€κ²½
   β… 10μ›” 31μΌ, 1μ›” 31μΌ, 3μ›” 31μΌ, ... λ¨λ‘ λ³€κ²½
   β… λ‹¤μ μ΅°ν μ‹μ—λ„ μ •μƒ ν‘μ‹

5. λ°λ³µ μ ν• λ³€κ²½:
   β… "λ§¤μ›” β†’ λ§¤μ£Ό" λ³€κ²½ κ°€λ¥
   β… μ „μ²΄ μ‹λ¦¬μ¦κ°€ λ§¤μ£Ό λ°λ³µμΌλ΅ λ³€κ²½
```

**κ²°κ³Ό**:
- β… νƒ€μ΄ν‹€ "31" μ΄λ²¤νΈ μμ • κ°€λ¥
- β… λ°λ³µ μΌμ • μ „μ²΄ μ‹λ¦¬μ¦ μμ •
- β… λ°μ΄ν„° λ¬΄κ²°μ„± μ μ§€
- β… Virtual ID λ¬Έμ  ν•΄κ²°
- β… λ¨λ“  ν…μ¤νΈ ν†µκ³Ό

μ΄μ  μ‚¬μ©μλ‹κ»μ„ "31" μ΄λ²¤νΈλ¥Ό ν¬ν•¨ν• λ¨λ“  λ°λ³µ μΌμ •μ„ μμ λ΅­κ² μμ •ν•  μ μμµλ‹λ‹¤! π€

