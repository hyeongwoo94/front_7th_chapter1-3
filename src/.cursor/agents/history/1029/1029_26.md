질문 (원본):
2025-10-29

질문: 반복 일정 + 반복 일정 겹침 시에도 "계속 진행" 허용 (Option A 선택)

답변:

## 겹침 허용 규칙 변경 완료 ✅

### 작업 개요
- **작업 유형**: 일정 겹침 허용 로직 변경
- **구현 날짜**: 2025-10-29
- **Worker 역할**: Tools (노동자)
- **작업 방식**: TDD (Red → Green)

### 사용자 요청

**시나리오:**
1. 단일 일정과 반복 일정이 함께 있다
2. 단일 일정을 반복 일정으로 수정하려고 한다
3. **현재**: 중복 알림과 함께 반복 일정으로 변경이 안 된다
4. **요구사항**: 같은 날짜에 겹쳐도 "계속 진행" 버튼으로 반복 일정 변경 가능하게

**제시된 옵션:**
- **Option A** (선택됨): 모든 반복+반복 겹침 허용
- Option B: 일정 수정 시에만 반복+반복 허용
- Option C: 모든 겹침 허용
- Option D: 사용자 설정 추가

### 변경 사항

#### Before (기존 로직)
```typescript
// XOR 로직: 하나는 반복, 하나는 일반일 때만 bypass 허용
반복 + 일반 → ✅ "계속 진행" 허용
일반 + 일반 → ❌ "계속 진행" 불허
반복 + 반복 → ❌ "계속 진행" 불허
```

#### After (변경된 로직)
```typescript
// OR 로직: 하나라도 반복 일정이면 bypass 허용
반복 + 일반 → ✅ "계속 진행" 허용
일반 + 일반 → ❌ "계속 진행" 불허 (유지)
반복 + 반복 → ✅ "계속 진행" 허용 (변경)
```

**핵심 규칙:**
- 하나라도 반복 일정이 있으면 → bypass 허용
- 둘 다 일반 일정일 때만 → bypass 불허

### 수정된 파일

#### 1. `src/utils/overlapBypassLogic.ts` (전체 재작성)

**함수명 변경:**
- `hasRecurringNormalConflict()` → `shouldAllowOverlapBypass()`
- 더 명확한 의미: "bypass를 허용해야 하는가?"

**로직 변경:**
```typescript
// Before (XOR)
return newIsRecurring !== overlapIsRecurring;

// After (OR)
return newIsRecurring || overlapIsRecurring;
```

**주석 업데이트:**
```typescript
/**
 * Bypass is allowed when at least one event is recurring.
 * Only normal + normal overlaps are NOT allowed to bypass.
 * bypass는 하나라도 반복 일정이 있으면 허용됩니다.
 * 일반 + 일반 겹침만 bypass를 허용하지 않습니다.
 */
```

#### 2. `src/__tests__/unit/overlapBypassLogic.spec.ts`

**함수명 변경:**
- import 문 업데이트
- describe 블록 이름 업데이트
- 모든 함수 호출 업데이트 (7곳)

**테스트 수정:**
```typescript
// Line 62-69: 반복 + 반복 테스트
it('반복 일정끼리 겹치면 true를 반환한다 (bypass 허용)', () => {
  // ... 
  expect(result).toBe(true); // false → true
});

// Line 48-58: 테스트 설명 업데이트
it('여러 겹침 중 하나라도 반복 일정이 있으면 true를 반환한다', () => {
  // 반복+반복, 반복+일반 모두 true
  expect(result).toBe(true);
});
```

**테스트 결과:**
- ✅ 일반 + 일반: false (bypass 불가)
- ✅ 반복 + 일반: true (bypass 허용)
- ✅ 일반 + 반복: true (bypass 허용)
- ✅ 반복 + 반복: true (bypass 허용) ← 변경됨
- ✅ 여러 겹침: true (하나라도 반복이면)
- ✅ 겹침 없음: false
- ✅ EventForm 타입: true

#### 3. `src/App.tsx`

**import 문 업데이트:**
```typescript
import { shouldAllowOverlapBypass } from './utils/overlapBypassLogic';
```

**함수 호출 변경 (3곳):**
1. Line 188: `addOrUpdateEvent()` 내
2. Line 225: `handleEditSingle()` 내
3. Line 263: `handleEditAll()` 내

```typescript
// 모든 위치에서 동일하게 변경
const canBypass = shouldAllowOverlapBypass(eventData, overlapping);
```

### TDD 사이클

#### RED 단계 ✅
1. 테스트 파일에서 함수명 변경
2. "반복 + 반복" 테스트 기대값 변경: `false` → `true`
3. 테스트 실행 → 실패 확인

#### GREEN 단계 ✅
1. `overlapBypassLogic.ts` 함수명 변경
2. 로직 변경: `XOR (!=)` → `OR (||)`
3. `App.tsx`에서 함수 호출 변경 (3곳)
4. 테스트 실행 → 통과 확인

### 검증 결과

#### 단위 테스트 ✅
```bash
npm test -- src/__tests__/unit/overlapBypassLogic.spec.ts --run
✓ 7 passed (7)
Duration: 5ms
```

#### 전체 테스트 ✅
```bash
npm test -- --run
✓ Test Files: 14 passed (14)
✓ Tests: 137 passed (137)
Duration: 25.40s
```

#### TypeScript 검증 ✅
```bash
npm run lint:tsc
✓ No errors
```

#### Known Issue ⚠️
- Prettier 인코딩 문제 (기존 이슈, 기능 영향 없음)
- `medium.integration.spec.tsx`, `EditOptionsDialog.tsx`에서 발생
- 5개 포맷 오류 (기능은 정상 작동)

### 사용자 시나리오 검증

**Before (이전):**
```
사용자: 단일 일정 A (2025-10-01 09:00-10:00)를
       "매주 월요일 09:00-10:00" 반복 일정으로 변경 시도

시스템: 기존 반복 일정 B와 겹침 감지
       → ❌ "계속 진행" 버튼 없음
       → 변경 불가능
```

**After (현재):**
```
사용자: 단일 일정 A를 반복 일정으로 변경 시도

시스템: 기존 반복 일정 B와 겹침 감지
       → ✅ "계속 진행" 버튼 표시
       → 클릭하면 변경 가능
```

### 코드 품질

**함수명 개선:**
- `hasRecurringNormalConflict` (모호함)
- → `shouldAllowOverlapBypass` (명확함)

**로직 단순화:**
```typescript
// Before: XOR 로직 (복잡)
return newIsRecurring !== overlapIsRecurring;

// After: OR 로직 (직관적)
return newIsRecurring || overlapIsRecurring;
```

**주석 명확화:**
- 영어 + 한국어 주석으로 의도 명확히 전달
- "하나라도 반복 일정이면 허용" 규칙 명시

### 영향 범위

**변경된 동작:**
- 반복 일정 ↔ 반복 일정 겹침 시 "계속 진행" 가능

**유지된 동작:**
- 일반 일정 ↔ 일반 일정 겹침 시 "계속 진행" 불가
- 반복 일정 ↔ 일반 일정 겹침 시 "계속 진행" 가능

**영향받지 않는 부분:**
- 일정 CRUD 기본 기능
- 일정 뷰 (주별/월별)
- 검색 기능
- 알림 기능
- 반복 일정 수정 (단일/전체 선택)

### 장점

1. **사용자 유연성 증가**
   - 단일 → 반복 변경 시 자유로움
   - 반복 일정 간 겹침 허용

2. **일관성 유지**
   - "하나라도 반복"이라는 명확한 규칙
   - 일반+일반만 엄격하게 제한

3. **코드 품질 향상**
   - 함수명이 의도를 명확히 표현
   - OR 로직이 XOR보다 직관적

### 단점 및 대응

**잠재적 문제:**
- 반복 일정끼리 의도하지 않은 겹침 발생 가능

**대응 방안:**
1. 겹침 경고 다이얼로그가 여전히 표시됨
2. 사용자가 명시적으로 "계속 진행" 클릭 필요
3. 겹치는 일정 목록을 보여줌

### 다음 단계 제안

1. **반복 일정 삭제 기능 확장**
   - 현재: 전체 삭제만 가능
   - 제안: "해당 일정만 삭제" vs "전체 삭제" 선택 가능

2. **겹침 허용 설정 추가**
   - 사용자 설정에서 "반복 일정 겹침 허용" 옵션
   - 더 세밀한 제어 가능

3. **시각적 피드백 개선**
   - 겹치는 일정을 달력에서 시각적으로 표시
   - 색상이나 패턴으로 구분

### 관련 파일
- **History**: `src/.cursor/agents/history/1029/1029_20.md` (이전 overlap dialog 버그 수정)
- **History**: `src/.cursor/agents/history/1029/1029_25.md` (반복 일정 수정 기능)

